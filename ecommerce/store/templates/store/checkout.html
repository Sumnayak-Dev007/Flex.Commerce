{% extends 'store/layouts/main.html' %}
{% load static tailwind_tags %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta required name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    {% tailwind_css %}
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Breadcrumb -->
    <div class="py-4 bg-blue-600 dark:bg-blue-900 text-xl shadow-md">
        <div class="container mx-auto px-4">
            <a href="{% url 'home' %}" class="text-white hover:underline">Home /</a>
            <a href="{% url 'checkout' %}" class="text-white hover:underline">Checkout</a>
        </div>
    </div>

    <!-- Checkout Container -->
    <div class="container mt-4 mb-10">
        <form action="{% url 'placeorder' %}" method="POST">
            {% csrf_token %}
            <div class="flex flex-wrap">

                <!-- Left Section: Basic Details -->
                <div class="w-screen md:w-6/12 mx-2 md:mx-4">
                    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg mx-1 border border-gray-200 dark:border-gray-700 transition-colors duration-300">
                        <div class="p-6">
                            <h6 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Basic Details</h6>
                            <hr class="my-4 border-gray-300 dark:border-gray-700">
                            <div class="flex flex-wrap">

                                <!-- First Name -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">First Name</label>
                                    <input type="text" name="fname" value="{{ request.user.first_name }}" required
                                           placeholder="Enter first name"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Last Name -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Last Name</label>
                                    <input type="text" name="lname" value="{{ request.user.last_name }}" required
                                           placeholder="Enter last name"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Email -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                                    <input type="email" name="email" value="{{ request.user.email }}" required
                                           placeholder="Enter Email"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Phone -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Phone</label>
                                    <input type="text" name="phone" value="{{ profile.phone }}" required
                                           placeholder="Enter Phone"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Address (full width) -->
                                <div class="w-full px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Address</label>
                                    <textarea name="address" required placeholder="Enter Address"
                                              class="form-textarea mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">{{ profile.address }}</textarea>
                                </div>

                                <!-- City -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">City</label>
                                    <input type="text" name="city" value="{{ profile.city }}" required
                                           placeholder="Enter City"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- State -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">State</label>
                                    <input type="text" name="state" value="{{ profile.state }}" required
                                           placeholder="Enter State"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Country -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Country</label>
                                    <input type="text" name="country" value="{{ profile.country }}" required
                                           placeholder="Enter Country"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                                <!-- Pincode -->
                                <div class="w-full md:w-1/2 px-3 mb-4">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Pin Code</label>
                                    <input type="text" name="pincode" value="{{ profile.pincode }}" required
                                           placeholder="Enter Pin Code"
                                           class="form-input mt-1 dark:text-white block w-full border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md shadow-sm">
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section: Order Summary (unchanged logic/JS) -->
                <div class="w-screen md:w-5/12 m-2">
                    <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 transition-colors duration-300">
                        <div class="p-4"> 
                            <h6 class="text-lg font-semibold text-gray-800 dark:text-gray-100 dark:text-white">Order Summary</h6>
                            <hr class="my-4 border-gray-300 dark:border-gray-700">

                            {% if cart %}
                                <table class="min-w-full table-auto border-collapse">
                                    <thead>
                                        <tr class="border-b border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300">
                                            <th class="px-4 py-2 dark:text-white text-left">Product</th>
                                            <th class="px-4 py-2 dark:text-white text-left">Qty</th>
                                            <th class="px-4 py-2 dark:text-white text-left">Price</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in cart %}
                                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                                <td class="px-4 py-2 flex items-center text-gray-800 dark:text-white dark:text-gray-100">
                                                    <img src="{{ item.Product.product_image.url }}" class="h-12 w-12  object-cover mr-4 rounded-md border border-gray-300 dark:border-gray-600">
                                                    {{ item.Product.name }}
                                                </td>
                                                <td class="px-4 py-2 dark:text-white text-gray-800 dark:text-gray-100">{{ item.product_qty }}</td>
                                                <td class="px-4 py-2 dark:text-white text-gray-800 dark:text-gray-100">{{ item.Product.selling_price|stringformat:'d' }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <h6 class="font-bold text-lg mt-4 text-gray-800 dark:text-white flex justify-between">
                                    Grand Total
                                    <span>â‚¹{{ total|stringformat:'d' }}</span>
                                </h6>

                                <input type="hidden" required name="payment_mode" value="COD">

                                <div class="mt-4 space-y-3">
                                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-500 text-white py-2 px-4 rounded-lg font-semibold transition">Cash On Delivery</button>

                                    <button type="button" class="paywithRzr w-full bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold transition">UPI / Wallet</button>

                                    <div id="paypal-button-container" onclick="return false;" class="mt-2"></div>
                                </div>
                            {% else %}
                                <h4 class="text-xl font-medium text-gray-700 dark:text-white">Your cart is empty</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        </form>
    </div>

    {% block scripts %}
    <!-- Keep your JS unchanged -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AVXsToEdXgfXTyK7k4Kyho2H8oFGd28fy6wALJE5u0pmj6_INzlnyoiV8pmmGKOsMg3qBXmfbzla427A&currency=USD"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        paypal.Buttons({
            style: { height: 40 },
            onClick: function(data, actions) {
                var fields = ['fname','lname','email','phone','address','city','state','country','pincode'];
                for (let field of fields) {
                    if ($(`[name='${field}']`).val() === "") {
                        swal("Alert!", "All Fields Are Mandatory!", "error");
                        return false;
                    }
                }
            },
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units: [{ amount: { value: ({{ total|stringformat:'d' }}/80).toFixed(2) } }]
                });
            },
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(orderData) {
                    var details = {
                        "fname": $("[name='fname']").val(),
                        "lname": $("[name='lname']").val(),
                        "email": $("[name='email']").val(),
                        "phone": $("[name='phone']").val(),
                        "address": $("[name='address']").val(),
                        "city": $("[name='city']").val(),
                        "state": $("[name='state']").val(),
                        "country": $("[name='country']").val(),
                        "pincode": $("[name='pincode']").val(),
                        "payment_mode": "Paid by Paypal",
                        "payment_id": orderData.id,
                        csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                    };
                    $.ajax({
                        method: "POST",
                        url: "/placeorder/",
                        data: details,
                        success: function (responsec) {
                            swal("Congratulations!", responsec.status, "success", { button: "OK" })
                            .then(() => { window.location.href = '/my-orders/'; });
                        }
                    });
                });
            }
        }).render('#paypal-button-container');
    </script>

    <script>
        document.getElementById('paypal-button-container').addEventListener('click', function(event) {
            event.stopPropagation();
        });
    </script>
    {% endblock scripts %}
</body>
</html>
{% endblock %}
